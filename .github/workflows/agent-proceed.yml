name: AI Agent - Proceed with Implementation

on:
  issue_comment:
    types: [created]

jobs:
  proceed:
    if: github.event.comment.body == '/proceed' || contains(github.event.comment.body, '/proceed')
    runs-on: ubuntu-latest
    environment:
      name: agent-implementation
      # This creates the approval gate - configure required reviewers in GitHub Settings
    permissions:
      contents: write
      issues: write
      pull-requests: write
      checks: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Find plan run ID from comment
        id: find_plan
        uses: actions/github-script@v7
        with:
          script: |
            // Find the most recent plan comment with a run ID
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
            });
            
            // Look for comment with "Agent Plan Run ID"
            let planRunId = null;
            for (const comment of comments.data.reverse()) {
              const match = comment.body.match(/Agent Plan Run ID: (\d+)/);
              if (match) {
                planRunId = match[1];
                break;
              }
            }
            
            if (!planRunId) {
              core.setFailed('Could not find plan run ID. Please ensure the plan workflow completed successfully.');
              return;
            }
            
            core.setOutput('run_id', planRunId);

      - name: Download plan artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          name: agent-plan
          path: plan-artifact/
          github_token: ${{ secrets.GITHUB_TOKEN }}
          run_id: ${{ steps.find_plan.outputs.run_id }}
          if_no_artifact_found: fail
          workflow: agent-plan.yml

      - name: Read plan context
        id: plan_context
        run: |
          if [ -f plan-artifact/prompt.txt ]; then
            PROMPT=$(cat plan-artifact/prompt.txt)
            ROLE=$(cat plan-artifact/role.txt)
            RUNTIME=$(cat plan-artifact/runtime.txt)
            
            JIRA_KEY=""
            if [ -f plan-artifact/jira_ticket.txt ]; then
              JIRA_KEY=$(cat plan-artifact/jira_ticket.txt)
            fi
          
            echo "PROMPT=$PROMPT" >> $GITHUB_OUTPUT
            echo "ROLE=$ROLE" >> $GITHUB_OUTPUT
            echo "RUNTIME=$RUNTIME" >> $GITHUB_OUTPUT
            echo "JIRA_KEY=$JIRA_KEY" >> $GITHUB_OUTPUT
          else
            echo "No plan artifact found. Please trigger the plan workflow first."
            exit 1
          fi

      - name: Setup Branch
        id: setup_branch
        run: |
          JIRA_KEY="${{ steps.plan_context.outputs.JIRA_KEY }}"
          if [ -n "$JIRA_KEY" ]; then
             # Convert to lowercase
             KEY_LOWER=$(echo "$JIRA_KEY" | tr '[:upper:]' '[:lower:]')
             BRANCH_NAME="feature/$KEY_LOWER"
             
             echo "Target Branch: $BRANCH_NAME"
             echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_OUTPUT
             
             # Configure Git
             git config --global user.name "github-actions[bot]"
             git config --global user.email "github-actions[bot]@users.noreply.github.com"
             
             # Fetch origin
             git fetch origin
             
             # Switch to branch
             if git rev-parse --verify "origin/$BRANCH_NAME" >/dev/null 2>&1; then
                echo "Branch exists remotely. Checking out..."
                git checkout -B "$BRANCH_NAME" "origin/$BRANCH_NAME"
             else
                echo "Branch does not exist. Creating new..."
                git checkout -b "$BRANCH_NAME"
             fi
          else
             echo "No Jira ticket found. Staying on current branch."
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      - name: Configure MCP Servers
        run: |
          mkdir -p ~/.gemini
          
          # Use Node.js to generate proper JSON
          node << 'EOF'
          const fs = require('fs');
          const mcpServers = {};
          
          // Add Notion MCP (required for contract)
          if (process.env.NOTION_API_KEY) {
            mcpServers.notion = {
              command: "npx",
              args: ["-y", "@modelcontextprotocol/server-notion"],
              env: {
                NOTION_API_KEY: process.env.NOTION_API_KEY
              }
            };
          }
          
          // Add Atlassian Rovo MCP (optional)
          if (process.env.ATLASSIAN_MCP_URL) {
            mcpServers["atlassian-rovo-mcp-server"] = {
              url: process.env.ATLASSIAN_MCP_URL,
              auth: {
                type: "oauth2",
                clientId: process.env.ATLASSIAN_MCP_CLIENT_ID,
                clientSecret: process.env.ATLASSIAN_MCP_CLIENT_SECRET
              }
            };
          }
          
          const config = {
            mcpServers: mcpServers
          };
          
          fs.writeFileSync(
            process.env.HOME + '/.gemini/settings.json',
            JSON.stringify(config, null, 2)
          );
          
          console.log('MCP servers configured:');
          console.log(JSON.stringify(config, null, 2));
          EOF
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          ATLASSIAN_MCP_URL: ${{ secrets.ATLASSIAN_MCP_URL }}
          ATLASSIAN_MCP_CLIENT_ID: ${{ secrets.ATLASSIAN_MCP_CLIENT_ID }}
          ATLASSIAN_MCP_CLIENT_SECRET: ${{ secrets.ATLASSIAN_MCP_CLIENT_SECRET }}

      - name: Setup environment
        run: |
          chmod +x scripts/agent.sh
          chmod +x scripts/runtimes/*.sh

      - name: Run agent implementation phase
        id: agent_implement
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set +e  # Don't fail immediately, capture output
          
          OUTPUT_FILE=$(mktemp)
          ERROR_FILE=$(mktemp)
          
          # Modify the prompt to include proceed instruction
          PROCEED_PROMPT="${{ steps.plan_context.outputs.PROMPT }}"$'\n\n'"Proceed with the implementation."
          
          ./scripts/agent.sh \
            --runtime "${{ steps.plan_context.outputs.RUNTIME }}" \
            --role "${{ steps.plan_context.outputs.ROLE }}" \
            "$PROCEED_PROMPT" \
            > "$OUTPUT_FILE" 2> "$ERROR_FILE"
          
          EXIT_CODE=$?
          
          # Save outputs
          echo "IMPLEMENTATION_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat "$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "IMPLEMENTATION_ERROR<<EOF" >> $GITHUB_OUTPUT
          cat "$ERROR_FILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Save to files for summary
          mkdir -p implementation-artifact
          cp "$OUTPUT_FILE" implementation-artifact/output.txt
          cp "$ERROR_FILE" implementation-artifact/error.txt
          
          rm -f "$OUTPUT_FILE" "$ERROR_FILE"
          
          exit $EXIT_CODE

      - name: Commit and Push Changes
        if: steps.setup_branch.outputs.BRANCH_NAME != ''
        run: |
           BRANCH_NAME="${{ steps.setup_branch.outputs.BRANCH_NAME }}"
           git add .
           if ! git diff --cached --quiet; then
              git commit -m "feat: Implementation for ${{ steps.plan_context.outputs.JIRA_KEY }}"
              git push origin "$BRANCH_NAME"
           else
              echo "No changes to commit."
           fi

      - name: Display implementation output
        if: always()
        run: |
          if [ -f implementation-artifact/output.txt ]; then
            echo "## ✅ Implementation Output" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat implementation-artifact/output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          
            echo "=== Implementation Output ==="
            cat implementation-artifact/output.txt
          fi
          
          if [ -f implementation-artifact/error.txt ] && [ -s implementation-artifact/error.txt ]; then
            echo "## ⚠️ Implementation Errors" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat implementation-artifact/error.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          
            echo "=== Errors ==="
            cat implementation-artifact/error.txt
          fi

      - name: Post implementation summary
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ✅ Implementation Complete
            
            The AI Agent has completed the implementation based on the approved plan.
            
            **Next steps:**
            - Review the changes in this PR
            - Run tests locally if needed
            - Merge when ready`;
            
            github.rest.issues.createComment({
              issue_number: context.payload.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });