name: AI Agent - Proceed with Implementation

on:
  issue_comment:
    types: [created]

jobs:
  proceed:
    # Only run if comment is exactly "/proceed" or starts with it
    if: startsWith(github.event.comment.body, '/proceed')
    runs-on: ubuntu-latest
    environment:
      name: agent-implementation
      # This creates the approval gate - configure required reviewers in GitHub Settings
    permissions:
      contents: write
      issues: write
      pull-requests: write
      checks: write
      actions: read # Required to download artifacts from other runs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Find plan run ID from comment
        id: find_plan
        uses: actions/github-script@v7
        with:
          script: |
            // Find the most recent plan comment with a run ID
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
            });
            
            // Look for comment with "**Run ID:** <number>" (Matches agent-plan.yml output)
            let planRunId = null;
            for (const comment of comments.data.reverse()) {
              // Regex updated to match the bold markdown used in the Plan phase
              const match = comment.body.match(/Run ID:\*\* (\d+)/) || comment.body.match(/Run ID: (\d+)/);
              if (match) {
                planRunId = match[1];
                break;
              }
            }
            
            if (!planRunId) {
              core.setFailed('Could not find a Plan Run ID in the comments. Please ensure the Plan workflow finished successfully.');
              return;
            }
            
            console.log(`Found Plan Run ID: ${planRunId}`);
            core.setOutput('run_id', planRunId);

      - name: Download Context Artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          name: agent-context   # <--- CHANGED: We need the context (prompts), not the output
          path: plan-context/
          github_token: ${{ secrets.GITHUB_TOKEN }}
          run_id: ${{ steps.find_plan.outputs.run_id }}
          if_no_artifact_found: fail
          workflow: agent-plan.yml

      - name: Read plan context
        id: plan_context
        run: |
          # Now reading from the correct folder 'plan-context'
          if [ -f plan-context/prompt.txt ]; then
            PROMPT=$(cat plan-context/prompt.txt)
            ROLE=$(cat plan-context/role.txt)
            RUNTIME=$(cat plan-context/runtime.txt)
          
            JIRA_KEY=""
            if [ -f plan-context/jira_ticket.txt ]; then
              JIRA_KEY=$(cat plan-context/jira_ticket.txt)
            fi
          
            echo "PROMPT=$PROMPT" >> $GITHUB_OUTPUT
            echo "ROLE=$ROLE" >> $GITHUB_OUTPUT
            echo "RUNTIME=$RUNTIME" >> $GITHUB_OUTPUT
            echo "JIRA_KEY=$JIRA_KEY" >> $GITHUB_OUTPUT
          else
            echo "No context files found. The artifact download might have failed."
            exit 1
          fi

      - name: Setup Branch
        id: setup_branch
        run: |
          JIRA_KEY="${{ steps.plan_context.outputs.JIRA_KEY }}"
          if [ -n "$JIRA_KEY" ]; then
             # Convert to lowercase
             KEY_LOWER=$(echo "$JIRA_KEY" | tr '[:upper:]' '[:lower:]')
             BRANCH_NAME="feature/$KEY_LOWER"
          
             echo "Target Branch: $BRANCH_NAME"
             echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
             # Configure Git
             git config --global user.name "github-actions[bot]"
             git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
             # Fetch origin
             git fetch origin
          
             # Switch to branch
             if git rev-parse --verify "origin/$BRANCH_NAME" >/dev/null 2>&1; then
                echo "Branch exists remotely. Checking out..."
                git checkout -B "$BRANCH_NAME" "origin/$BRANCH_NAME"
             else
                echo "Branch does not exist. Creating new..."
                git checkout -b "$BRANCH_NAME"
             fi
          else
             echo "No Jira ticket found. Staying on current branch."
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      - name: Configure MCP Servers
        run: |
          mkdir -p ~/.gemini
          
          node << 'EOF'
          const fs = require('fs');
          const mcpServers = {};
          
          if (process.env.NOTION_API_KEY) {
            mcpServers.notion = {
              command: "npx",
              args: ["-y", "@modelcontextprotocol/server-notion"],
              env: { NOTION_API_KEY: process.env.NOTION_API_KEY }
            };
          }
          
          const config = { mcpServers: mcpServers };
          
          fs.writeFileSync(
            process.env.HOME + '/.gemini/settings.json',
            JSON.stringify(config, null, 2)
          );
          EOF
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}

      - name: Setup environment
        run: |
          chmod +x scripts/agent.sh
          chmod +x scripts/runtimes/*.sh

      - name: Run agent implementation phase
        id: agent_implement
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          set +e
          
          OUTPUT_FILE=$(mktemp)
          ERROR_FILE=$(mktemp)
          
          # Append the instruction to proceed
          PROCEED_PROMPT="${{ steps.plan_context.outputs.PROMPT }}"$'\n\n'"**INSTRUCTION:** The plan is approved. Proceed with the implementation code now."
          
          echo "Executing Agent with role: ${{ steps.plan_context.outputs.ROLE }}"
          
          ./scripts/agent.sh \
            --runtime "${{ steps.plan_context.outputs.RUNTIME }}" \
            --role "${{ steps.plan_context.outputs.ROLE }}" \
            "$PROCEED_PROMPT" \
            > "$OUTPUT_FILE" 2> "$ERROR_FILE"
          
          EXIT_CODE=$?
          
          # Save outputs
          echo "IMPLEMENTATION_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat "$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "IMPLEMENTATION_ERROR<<EOF" >> $GITHUB_OUTPUT
          cat "$ERROR_FILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Save to files for summary
          mkdir -p implementation-artifact
          cp "$OUTPUT_FILE" implementation-artifact/output.txt
          cp "$ERROR_FILE" implementation-artifact/error.txt
          
          # Check exit code manually to ensure artifacts are uploaded before failing
          if [ $EXIT_CODE -ne 0 ]; then
             echo "Agent script failed with exit code $EXIT_CODE"
             exit $EXIT_CODE
          fi

      - name: Commit and Push Changes
        if: steps.setup_branch.outputs.BRANCH_NAME != ''
        run: |
          BRANCH_NAME="${{ steps.setup_branch.outputs.BRANCH_NAME }}"
          git add .
          if ! git diff --cached --quiet; then
             # Using a conventional commit message
             git commit -m "feat: Implementation for ${{ steps.plan_context.outputs.JIRA_KEY }}"
             git push origin "$BRANCH_NAME"
          else
             echo "No changes to commit."
          fi

      - name: Display implementation output
        if: always()
        run: |
          if [ -f implementation-artifact/output.txt ]; then
            echo "## ✅ Implementation Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat implementation-artifact/output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f implementation-artifact/error.txt ] && [ -s implementation-artifact/error.txt ]; then
            echo "## ⚠️ Implementation Errors" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat implementation-artifact/error.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Post implementation summary
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ✅ Implementation Complete
            
            The AI Agent has completed the implementation based on the approved plan.
            
            **Next steps:**
            1. Review the code changes in this PR.
            2. Run your tests locally.
            3. Merge when ready.`;
            
            github.rest.issues.createComment({
              issue_number: context.payload.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });