name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to deploy (branch, tag, or SHA)'
        required: false
        default: 'main'
      run_id:
        description: 'Build workflow run ID to deploy (optional - will auto-detect if not provided)'
        required: false

concurrency:
  group: production-deploy  # Simplified - only one production deploy at a time
  cancel-in-progress: false  # Don't cancel production deploys!

env:
  CONFIGURATION: Release

permissions:
  contents: read
  id-token: write
  actions: read  # Needed to download artifacts from other runs

jobs:
  deploy:
    name: Deploy to Production
    runs-on: windows-latest
    timeout-minutes: 30
    environment:
      name: production
      url: ${{ secrets.PRODUCTION_URL }}  # Shows deployment URL in GitHub

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0  # Need history for git describe

      # --------------------------------------------------
      # Get deployment metadata
      # --------------------------------------------------
      - name: Get version info
        id: version
        shell: bash
        run: |
          VERSION=$(git describe --tags --always --dirty)
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION (commit: $COMMIT_SHA)"

      # --------------------------------------------------
      # Find successful build run for this commit
      # --------------------------------------------------
      - name: Find successful build
        id: find_build
        uses: actions/github-script@v7
        with:
          script: |
            const runId = '${{ inputs.run_id }}';
            const commitSha = '${{ steps.version.outputs.commit_sha }}';
            
            // If run_id provided, verify it passed
            if (runId) {
              const { data: run } = await github.rest.actions.getWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: parseInt(runId)
              });
            
              if (run.conclusion !== 'success') {
                core.setFailed(`Run ${runId} did not succeed (status: ${run.conclusion})`);
                return;
              }
            
              core.setOutput('run_id', runId);
              core.setOutput('run_number', run.run_number);
              return;
            }
            
            // Auto-detect: find latest successful build for this commit
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build.yml',
              per_page: 50
            });
            
            const successfulRun = runs.workflow_runs.find(r => 
              r.head_sha === commitSha && r.conclusion === 'success'
            );
            
            if (!successfulRun) {
              core.setFailed(`No successful build found for commit ${commitSha}`);
              return;
            }
            
            core.setOutput('run_id', successfulRun.id.toString());
            core.setOutput('run_number', successfulRun.run_number.toString());
            core.info(`Found successful build: run ${successfulRun.id} (${successfulRun.html_url})`);

      # --------------------------------------------------
      # Download artifact from verified build run
      # --------------------------------------------------
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: web-app-package-${{ steps.find_build.outputs.run_number }}
          path: ./publish
          run-id: ${{ steps.find_build.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # --------------------------------------------------
      # Validate artifact contents
      # --------------------------------------------------
      - name: Validate artifact
        shell: powershell
        run: |
          $requiredFiles = @(
            "Oris.WebApplication.dll",
            "appsettings.json",
            "web.config"
          )
          
          foreach ($file in $requiredFiles) {
            $path = Join-Path ./publish $file
            if (-not (Test-Path $path)) {
              Write-Error "Missing required file: $file"
              exit 1
            }
          }
          
          Write-Host "âœ… Artifact validation passed"

      # --------------------------------------------------
      # Pre-deployment health check
      # --------------------------------------------------
      - name: Pre-deployment health check
        shell: powershell
        continue-on-error: true  # Site might be down, that's ok
        id: pre_health
        env:
          HEALTHCHECK_URL: ${{ secrets.PRODUCTION_HEALTHCHECK_URL }}
        run: |
          try {
            $response = Invoke-WebRequest -Uri $env:HEALTHCHECK_URL -Method Get -TimeoutSec 10 -UseBasicParsing
            Write-Host "Current site status: HTTP $($response.StatusCode)"
            echo "pre_deploy_healthy=true" >> $env:GITHUB_OUTPUT
          } catch {
            Write-Host "Site currently unhealthy or unreachable"
            echo "pre_deploy_healthy=false" >> $env:GITHUB_OUTPUT
          }

      # --------------------------------------------------
      # Install Web Deploy
      # --------------------------------------------------
      - name: Install Web Deploy
        shell: powershell
        run: |
          Write-Host "Installing Web Deploy..."
          choco install webdeploy -y --no-progress
          
          # Verify installation
          $msdeploy = Get-Command msdeploy.exe -ErrorAction SilentlyContinue
          if (-not $msdeploy) {
            Write-Error "Web Deploy installation failed"
            exit 1
          }
          
          Write-Host "âœ… Web Deploy installed: $($msdeploy.Source)"

      # --------------------------------------------------
      # Create deployment marker
      # --------------------------------------------------
      - name: Create deployment marker file
        shell: powershell
        run: |
          $deployInfo = @{
            version = "${{ steps.version.outputs.version }}"
            commit = "${{ steps.version.outputs.commit_sha }}"
            deployed_at = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
            deployed_by = "${{ github.actor }}"
            workflow_run = "${{ github.run_id }}"
            build_run = "${{ steps.find_build.outputs.run_id }}"
          }
          
          $deployInfo | ConvertTo-Json | Out-File -FilePath ./publish/deployment-info.json -Encoding UTF8
          Write-Host "Created deployment marker"

      # --------------------------------------------------
      # Deploy to IIS via WebDeploy
      # --------------------------------------------------
      - name: Deploy to IIS via WebDeploy
        shell: powershell
        env:
          WEBDEPLOY_SERVER: ${{ secrets.WEBDEPLOY_SERVER }}
          WEBDEPLOY_SITE_NAME: ${{ secrets.WEBDEPLOY_SITE_NAME }}
          WEBDEPLOY_USERNAME: ${{ secrets.WEBDEPLOY_USERNAME }}
          WEBDEPLOY_PASSWORD: ${{ secrets.WEBDEPLOY_PASSWORD }}
        run: |
          $msdeploy = Get-Command msdeploy.exe
          $publishPath = Convert-Path ./publish
          
          Write-Host "Starting deployment to $env:WEBDEPLOY_SITE_NAME..."
          
          $destArg = "contentPath='$env:WEBDEPLOY_SITE_NAME'," +
                     "computerName='https://$env:WEBDEPLOY_SERVER:8172/msdeploy.axd?site=$env:WEBDEPLOY_SITE_NAME'," +
                     "username='$env:WEBDEPLOY_USERNAME'," +
                     "password='$env:WEBDEPLOY_PASSWORD'," +
                     "authtype=Basic"
          
          try {
            & $msdeploy.Source `
              -verb:sync `
              -source:contentPath="$publishPath" `
              -dest:$destArg `
              -allowUntrusted `
              -enableRule:AppOffline `
              -enableRule:DoNotDeleteRule `
              -retryAttempts:3 `
              -retryInterval:5000 `
              -verbose
          
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Deployment failed with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
          
            Write-Host "âœ… Deployment completed successfully"
          } catch {
            Write-Error "Deployment exception: $($_.Exception.Message)"
            exit 1
          }

      # --------------------------------------------------
      # Post-deployment smoke tests
      # --------------------------------------------------
      - name: Smoke test - Health endpoint
        shell: powershell
        env:
          HEALTHCHECK_URL: ${{ secrets.PRODUCTION_HEALTHCHECK_URL }}
        run: |
          $maxAttempts = 10
          $delaySeconds = 10
          
          Write-Host "Waiting for application to start..."
          
          for ($attempt = 1; $attempt -le $maxAttempts; $attempt++) {
            try {
              Write-Host "Attempt $attempt/$maxAttempts..."
          
              $response = Invoke-WebRequest `
                -Uri $env:HEALTHCHECK_URL `
                -Method Get `
                -TimeoutSec 30 `
                -UseBasicParsing
          
              if ($response.StatusCode -ge 200 -and $response.StatusCode -lt 300) {
                Write-Host "âœ… Health check passed: HTTP $($response.StatusCode)"
          
                # Validate response content if possible
                if ($response.Content -match '"status"\s*:\s*"healthy"') {
                  Write-Host "âœ… Application reports healthy status"
                }
          
                exit 0
              } else {
                Write-Warning "Unexpected status code: $($response.StatusCode)"
              }
            } catch {
              Write-Host "âš ï¸  Attempt $attempt failed: $($_.Exception.Message)"
          
              if ($attempt -eq $maxAttempts) {
                Write-Error "âŒ Smoke test failed after $maxAttempts attempts"
                exit 1
              }
            }
          
            Start-Sleep -Seconds $delaySeconds
          }

      - name: Smoke test - Critical feature check
        shell: powershell
        continue-on-error: true  # Don't fail deployment, but warn
        env:
          API_BASE_URL: ${{ secrets.PRODUCTION_API_URL }}
        run: |
          # Example: Check a critical API endpoint
          try {
            $response = Invoke-WebRequest `
              -Uri "$env:API_BASE_URL/api/status" `
              -Method Get `
              -TimeoutSec 10 `
              -UseBasicParsing
          
            Write-Host "âœ… API endpoint responsive"
          } catch {
            Write-Warning "âš ï¸  API check failed (non-critical): $($_.Exception.Message)"
          }

      # --------------------------------------------------
      # Create GitHub deployment record
      # --------------------------------------------------
      - name: Record deployment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: '${{ steps.version.outputs.commit_sha }}',
              environment: 'production',
              description: 'Deployed version ${{ steps.version.outputs.version }}',
              auto_merge: false,
              required_contexts: []
            });

      # --------------------------------------------------
      # Generate deployment summary
      # --------------------------------------------------
      - name: Generate deployment summary
        if: always()
        shell: powershell
        run: |
          $summary = @"
          ### ðŸš€ Production Deployment Summary
          
          **Status:** ${{ job.status }}
          **Version:** ${{ steps.version.outputs.version }}
          **Commit:** ${{ steps.version.outputs.commit_sha }}
          **Build Run:** #${{ steps.find_build.outputs.run_number }}
          **Deployed by:** ${{ github.actor }}
          **Timestamp:** $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
          
          #### Pre-Deployment
          - Pre-deployment health: ${{ steps.pre_health.outputs.pre_deploy_healthy == 'true' && 'âœ… Healthy' || 'âš ï¸ Unhealthy' }}
          
          #### Deployment Steps
          - âœ… Artifact validated
          - âœ… Web Deploy executed
          - ${{ job.status == 'success' && 'âœ…' || 'âŒ' }} Smoke tests
          
          #### Links
          - [Build workflow](https://github.com/${{ github.repository }}/actions/runs/${{ steps.find_build.outputs.run_id }})
          - [Production site](${{ secrets.PRODUCTION_URL }})
          "@
          
          echo $summary >> $env:GITHUB_STEP_SUMMARY

      # --------------------------------------------------
      # Cleanup
      # --------------------------------------------------
      - name: Cleanup artifacts
        if: always()
        shell: powershell
        run: |
          if (Test-Path ./publish) {
            Remove-Item ./publish -Recurse -Force
            Write-Host "Cleaned up deployment artifacts"
          }