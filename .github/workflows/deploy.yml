name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to deploy (branch, tag, or SHA)'
        required: false
        default: 'main'
      run_id:
        description: 'Build workflow run ID to deploy (optional - will auto-detect if not provided)'
        required: false

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  CONFIGURATION: Release

permissions:
  contents: read
  id-token: write
  actions: read

jobs:
  deploy:
    name: Deploy to Production
    runs-on: windows-latest
    timeout-minutes: 30
    environment:
      name: production
      url: ${{ vars.PRODUCTION_URL }}

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      # --------------------------------------------------
      # Validate user inputs (Security hardening)
      # --------------------------------------------------
      - name: Validate inputs
        shell: bash
        env:
          INPUT_REF: ${{ inputs.ref }}
          INPUT_RUN_ID: ${{ inputs.run_id }}
        run: |
          # Validate ref (allow branches, tags, SHAs - alphanumeric, slash, dash, underscore, dot)
          if [[ -n "$INPUT_REF" ]] && [[ ! "$INPUT_REF" =~ ^[a-zA-Z0-9/_.-]+$ ]]; then
            echo "::error::Invalid ref format. Only alphanumeric characters, slashes, dashes, underscores, and dots allowed."
            exit 1
          fi
          
          # Validate run_id if provided (must be numeric)
          if [[ -n "$INPUT_RUN_ID" ]] && [[ ! "$INPUT_RUN_ID" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid run_id. Must be a positive number."
            exit 1
          fi
          
          echo "‚úÖ Input validation passed"

      # --------------------------------------------------
      # Get deployment metadata
      # --------------------------------------------------
      - name: Get version info
        id: version
        shell: bash
        run: |
          VERSION=$(git describe --tags --always --dirty)
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION (commit: $COMMIT_SHA)"

      # --------------------------------------------------
      # Find successful build run for this commit
      # --------------------------------------------------
      - name: Find successful build
        id: find_build
        uses: actions/github-script@v7
        env:
          INPUT_RUN_ID: ${{ inputs.run_id }}
          COMMIT_SHA: ${{ steps.version.outputs.commit_sha }}
        with:
          script: |
            const runId = process.env.INPUT_RUN_ID;
            const commitSha = process.env.COMMIT_SHA;
            
            // If run_id provided, verify it passed
            if (runId) {
              const parsedRunId = parseInt(runId);
              if (isNaN(parsedRunId)) {
                core.setFailed('Invalid run_id format');
                return;
              }
            
              const { data: run } = await github.rest.actions.getWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: parsedRunId
              });
            
              if (run.conclusion !== 'success') {
                core.setFailed(`Run ${parsedRunId} did not succeed (status: ${run.conclusion})`);
                return;
              }
            
              core.setOutput('run_id', runId);
              core.setOutput('run_number', run.run_number.toString());
              return;
            }
            
            // Auto-detect: find latest successful build for this commit
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build.yml',
              per_page: 50
            });
            
            const successfulRun = runs.workflow_runs.find(r => 
              r.head_sha === commitSha && r.conclusion === 'success'
            );
            
            if (!successfulRun) {
              core.setFailed(`No successful build found for commit ${commitSha}`);
              return;
            }
            
            core.setOutput('run_id', successfulRun.id.toString());
            core.setOutput('run_number', successfulRun.run_number.toString());
            core.info(`Found successful build: run ${successfulRun.id} (${successfulRun.html_url})`);

      # --------------------------------------------------
      # Download artifact from verified build run
      # --------------------------------------------------
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: web-app-package-${{ steps.find_build.outputs.run_number }}
          path: ./publish
          run-id: ${{ steps.find_build.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # --------------------------------------------------
      # Validate artifact contents
      # --------------------------------------------------
      - name: Validate artifact
        shell: powershell
        run: |
          $requiredFiles = @(
            "Oris.WebApplication.dll",
            "appsettings.json",
            "web.config"
          )
          
          foreach ($file in $requiredFiles) {
            $path = Join-Path ./publish $file
            if (-not (Test-Path $path)) {
              Write-Error "Missing required file: $file"
              exit 1
            }
          }
          
          Write-Host "‚úÖ Artifact validation passed"

      # --------------------------------------------------
      # Pre-deployment health check
      # --------------------------------------------------
      - name: Pre-deployment health check
        shell: powershell
        continue-on-error: true
        id: pre_health
        env:
          HEALTHCHECK_URL: ${{ secrets.PRODUCTION_HEALTHCHECK_URL }}
        run: |
          try {
            $response = Invoke-WebRequest -Uri $env:HEALTHCHECK_URL -Method Get -TimeoutSec 10 -UseBasicParsing
            Write-Host "Current site status: HTTP $($response.StatusCode)"
            echo "pre_deploy_healthy=true" >> $env:GITHUB_OUTPUT
          } catch {
            Write-Host "Site currently unhealthy or unreachable"
            echo "pre_deploy_healthy=false" >> $env:GITHUB_OUTPUT
          }

      # --------------------------------------------------
      # Install Web Deploy
      # --------------------------------------------------
      - name: Install Web Deploy
        shell: powershell
        run: |
          function Find-MsDeploy {
            $cmd = Get-Command msdeploy.exe -ErrorAction SilentlyContinue
            if ($cmd) { return $cmd.Source }

            $candidates = @(
              "$env:ProgramFiles\IIS\Microsoft Web Deploy V3\msdeploy.exe",
              "${env:ProgramFiles(x86)}\IIS\Microsoft Web Deploy V3\msdeploy.exe"
            )

            foreach ($path in $candidates) {
              if (Test-Path $path) { return $path }
            }

            return $null
          }

          $msdeployPath = Find-MsDeploy
          if ($msdeployPath) {
            Write-Host "Web Deploy already available: $msdeployPath"
          } else {
            Write-Host "Installing Web Deploy..."
            choco install webdeploy -y --no-progress
            $msdeployPath = Find-MsDeploy
          }

          if (-not $msdeployPath) {
            Write-Error "Web Deploy installation failed: msdeploy.exe not found after install."
            exit 1
          }

          $msdeployDir = Split-Path -Path $msdeployPath -Parent
          if ($env:Path -notlike "*$msdeployDir*") {
            $env:Path = "$env:Path;$msdeployDir"
          }
          $msdeployDir >> $env:GITHUB_PATH

          Write-Host "‚úÖ Web Deploy ready: $msdeployPath"

      # --------------------------------------------------
      # Create deployment marker
      # --------------------------------------------------
      - name: Create deployment marker file
        shell: powershell
        env:
          VERSION: ${{ steps.version.outputs.version }}
          COMMIT_SHA: ${{ steps.version.outputs.commit_sha }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          BUILD_RUN_ID: ${{ steps.find_build.outputs.run_id }}
        run: |
          $timestamp = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
          
          $deployInfo = @{
            version = $env:VERSION
            commit = $env:COMMIT_SHA
            deployed_at = $timestamp
            deployed_by = $env:GITHUB_ACTOR
            workflow_run = $env:GITHUB_RUN_ID
            build_run = $env:BUILD_RUN_ID
          }
          
          $deployInfo | ConvertTo-Json | Out-File -FilePath ./publish/deployment-info.json -Encoding UTF8
          Write-Host "Created deployment marker"

      # --------------------------------------------------
      # Deploy to IIS via WebDeploy
      # --------------------------------------------------
      - name: Deploy to IIS via WebDeploy
        shell: powershell
        env:
          WEBDEPLOY_SERVER: ${{ secrets.WEBDEPLOY_SERVER }}
          WEBDEPLOY_SITE_NAME: ${{ secrets.WEBDEPLOY_SITE_NAME }}
          WEBDEPLOY_USERNAME: ${{ secrets.WEBDEPLOY_USERNAME }}
          WEBDEPLOY_PASSWORD: ${{ secrets.WEBDEPLOY_PASSWORD }}
        run: |
          $msdeploy = Get-Command msdeploy.exe -ErrorAction SilentlyContinue
          if (-not $msdeploy) {
            $candidatePaths = @(
              "$env:ProgramFiles\IIS\Microsoft Web Deploy V3\msdeploy.exe",
              "${env:ProgramFiles(x86)}\IIS\Microsoft Web Deploy V3\msdeploy.exe"
            )
            $resolved = $candidatePaths | Where-Object { Test-Path $_ } | Select-Object -First 1
            if ($resolved) {
              $msdeploy = @{ Source = $resolved }
            } else {
              Write-Error "msdeploy.exe not found on runner."
              exit 1
            }
          }
          $publishPath = Convert-Path ./publish
          
          Write-Host "Starting deployment to $env:WEBDEPLOY_SITE_NAME..."
          
          $destArg = "contentPath='$env:WEBDEPLOY_SITE_NAME'," +
                     "computerName='https://$env:WEBDEPLOY_SERVER:8172/msdeploy.axd?site=$env:WEBDEPLOY_SITE_NAME'," +
                     "username='$env:WEBDEPLOY_USERNAME'," +
                     "password='$env:WEBDEPLOY_PASSWORD'," +
                     "authtype=Basic"
          
          try {
            & $msdeploy.Source `
              -verb:sync `
              -source:contentPath="$publishPath" `
              -dest:$destArg `
              -allowUntrusted `
              -enableRule:AppOffline `
              -enableRule:DoNotDeleteRule `
              -retryAttempts:3 `
              -retryInterval:5000 `
              -verbose
          
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Deployment failed with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
          
            Write-Host "‚úÖ Deployment completed successfully"
          } catch {
            Write-Error "Deployment exception: $($_.Exception.Message)"
            exit 1
          }

      # --------------------------------------------------
      # Post-deployment smoke tests
      # --------------------------------------------------
      - name: Smoke test - Health endpoint
        shell: powershell
        env:
          HEALTHCHECK_URL: ${{ secrets.PRODUCTION_HEALTHCHECK_URL }}
        run: |
          $maxAttempts = 10
          $delaySeconds = 10
          
          Write-Host "Waiting for application to start..."
          
          for ($attempt = 1; $attempt -le $maxAttempts; $attempt++) {
            try {
              Write-Host "Attempt $attempt/$maxAttempts..."
          
              $response = Invoke-WebRequest `
                -Uri $env:HEALTHCHECK_URL `
                -Method Get `
                -TimeoutSec 30 `
                -UseBasicParsing
          
              if ($response.StatusCode -ge 200 -and $response.StatusCode -lt 300) {
                Write-Host "‚úÖ Health check passed: HTTP $($response.StatusCode)"
          
                # Validate response content if possible
                if ($response.Content -match '"status"\s*:\s*"healthy"') {
                  Write-Host "‚úÖ Application reports healthy status"
                }
          
                exit 0
              } else {
                Write-Warning "Unexpected status code: $($response.StatusCode)"
              }
            } catch {
              Write-Host "‚ö†Ô∏è  Attempt $attempt failed: $($_.Exception.Message)"
          
              if ($attempt -eq $maxAttempts) {
                Write-Error "‚ùå Smoke test failed after $maxAttempts attempts"
                exit 1
              }
            }
          
            Start-Sleep -Seconds $delaySeconds
          }

      - name: Smoke test - Critical feature check
        shell: powershell
        continue-on-error: true
        env:
          API_BASE_URL: ${{ secrets.PRODUCTION_API_URL }}
        run: |
          # Example: Check a critical API endpoint
          try {
            $response = Invoke-WebRequest `
              -Uri "$env:API_BASE_URL/api/status" `
              -Method Get `
              -TimeoutSec 10 `
              -UseBasicParsing
          
            Write-Host "‚úÖ API endpoint responsive"
          } catch {
            Write-Warning "‚ö†Ô∏è  API check failed (non-critical): $($_.Exception.Message)"
          }

      # --------------------------------------------------
      # Create GitHub deployment record
      # --------------------------------------------------
      - name: Record deployment
        if: success()
        uses: actions/github-script@v7
        env:
          COMMIT_SHA: ${{ steps.version.outputs.commit_sha }}
          VERSION: ${{ steps.version.outputs.version }}
        with:
          script: |
            await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: process.env.COMMIT_SHA,
              environment: 'production',
              description: `Deployed version ${process.env.VERSION}`,
              auto_merge: false,
              required_contexts: []
            });

      # --------------------------------------------------
      # Generate deployment summary
      # --------------------------------------------------
      - name: Generate deployment summary
        if: always()
        shell: powershell
        env:
          JOB_STATUS: ${{ job.status }}
          VERSION: ${{ steps.version.outputs.version }}
          COMMIT_SHA: ${{ steps.version.outputs.commit_sha }}
          BUILD_RUN_NUMBER: ${{ steps.find_build.outputs.run_number }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          BUILD_RUN_ID: ${{ steps.find_build.outputs.run_id }}
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}
          PRE_DEPLOY_HEALTHY: ${{ steps.pre_health.outputs.pre_deploy_healthy }}
        run: |
          $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC"
          
          $preHealthStatus = if ($env:PRE_DEPLOY_HEALTHY -eq 'true') { '‚úÖ Healthy' } else { '‚ö†Ô∏è Unhealthy' }
          $finalStatus = if ($env:JOB_STATUS -eq 'success') { '‚úÖ' } else { '‚ùå' }
          
          $summary = @"
          ### üöÄ Production Deployment Summary
          
          **Status:** $env:JOB_STATUS
          **Version:** $env:VERSION
          **Commit:** $env:COMMIT_SHA
          **Build Run:** #$env:BUILD_RUN_NUMBER
          **Deployed by:** $env:GITHUB_ACTOR
          **Timestamp:** $timestamp
          
          #### Pre-Deployment
          - Pre-deployment health: $preHealthStatus
          
          #### Deployment Steps
          - ‚úÖ Artifact validated
          - ‚úÖ Web Deploy executed
          - $finalStatus Smoke tests
          
          #### Links
          - [Build workflow](https://github.com/$env:GITHUB_REPOSITORY/actions/runs/$env:BUILD_RUN_ID)
          - [Production site]($env:PRODUCTION_URL)
          "@
          
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8

      # --------------------------------------------------
      # Cleanup
      # --------------------------------------------------
      - name: Cleanup artifacts
        if: always()
        shell: powershell
        run: |
          if (Test-Path ./publish) {
            Remove-Item ./publish -Recurse -Force
            Write-Host "Cleaned up deployment artifacts"
          }
