name: AI Agent - Plan Phase

on:
  # Manual trigger via GitHub UI
  workflow_dispatch:
    inputs:
      jira_ticket:
        description: 'Jira ticket key (e.g., OR-25)'
        required: true
        type: string
      role:
        description: 'Agent role'
        required: false
        default: 'backend'
        type: choice
        options:
          - backend
      runtime:
        description: 'AI Runtime'
        required: false
        default: 'gemini'
        type: choice
        options:
          - gemini
          - claude
          - codex
  # Trigger via comments (/agent or /revise)
  issue_comment:
    types: [created]

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      checks: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract trigger context
        id: context
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_JIRA_TICKET: ${{ github.event.inputs.jira_ticket }}
          INPUT_ROLE: ${{ github.event.inputs.role }}
          INPUT_RUNTIME: ${{ github.event.inputs.runtime }}
          COMMENT_BODY_VAL: ${{ github.event.comment.body }}
          ISSUE_NUMBER_VAL: ${{ github.event.issue.number }}
          ISSUE_TITLE_VAL: ${{ github.event.issue.title }}
        run: |
          JIRA_KEY=""
          # 1. Handle Manual Trigger (Workflow Dispatch)
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            JIRA_KEY="$INPUT_JIRA_TICKET"
            echo "PROMPT=Work on Jira ticket $JIRA_KEY" >> $GITHUB_OUTPUT
            echo "ROLE=$INPUT_ROLE" >> $GITHUB_OUTPUT
            echo "RUNTIME=$INPUT_RUNTIME" >> $GITHUB_OUTPUT
            echo "ISSUE_NUMBER=" >> $GITHUB_OUTPUT

          # 2. Handle Comment Trigger (ChatOps)
          elif [ "$EVENT_NAME" = "issue_comment" ]; then
            COMMENT_BODY="$COMMENT_BODY_VAL"
          
            # Case A: New Plan (/agent ...)
            if echo "$COMMENT_BODY" | grep -qE "^\s*/agent\s+"; then
              PROMPT=$(echo "$COMMENT_BODY" | sed -E 's|^\s*/agent\s+||')
              JIRA_KEY=$(echo "$PROMPT" | grep -oE '[A-Z]+-[0-9]+' | head -1 || echo "")
              echo "PROMPT=$PROMPT" >> $GITHUB_OUTPUT
              echo "ROLE=backend" >> $GITHUB_OUTPUT
              echo "RUNTIME=gemini" >> $GITHUB_OUTPUT
              echo "ISSUE_NUMBER=$ISSUE_NUMBER_VAL" >> $GITHUB_OUTPUT
              echo "IS_REVISION=false" >> $GITHUB_OUTPUT
          
            # Case B: Revision (/revise ...)
            elif echo "$COMMENT_BODY" | grep -qE "^\s*/revise\s+"; then
              REVISION_FEEDBACK=$(echo "$COMMENT_BODY" | sed -E 's|^\s*/revise\s+||')
              ISSUE_TITLE="$ISSUE_TITLE_VAL"
              JIRA_KEY=$(echo "$ISSUE_TITLE" | grep -oE '[A-Z]+-[0-9]+' | head -1 || echo "")
              echo "REVISION_FEEDBACK=$REVISION_FEEDBACK" >> $GITHUB_OUTPUT
              echo "IS_REVISION=true" >> $GITHUB_OUTPUT
              echo "ISSUE_NUMBER=$ISSUE_NUMBER_VAL" >> $GITHUB_OUTPUT
              echo "ROLE=backend" >> $GITHUB_OUTPUT
              echo "RUNTIME=gemini" >> $GITHUB_OUTPUT
            else
              echo "SKIP=true" >> $GITHUB_OUTPUT
            fi
          fi
          
          echo "JIRA_KEY=$JIRA_KEY" >> $GITHUB_OUTPUT

      - name: Skip if not agent trigger
        if: steps.context.outputs.SKIP == 'true'
        run: |
          echo "Not an agent trigger, skipping..."
          exit 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache npm packages
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install AI CLI Tools
        run: |
          npm install -g @google/gemini-cli

      - name: Setup environment
        run: |
          chmod +x scripts/agent.sh
          chmod +x scripts/runtimes/*.sh

      - name: Handle plan revision
        if: steps.context.outputs.IS_REVISION == 'true'
        id: revision_context
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.context.outputs.ISSUE_NUMBER }}'),
            });
            
            let originalPrompt = null;
            let planRunId = null;
            for (const comment of comments.data.reverse()) {
              const runIdMatch = comment.body.match(/Agent Plan Run ID: (\d+)/);
              if (runIdMatch && comment.body.includes('ðŸ¤– AI Agent Plan')) {
                planRunId = runIdMatch[1];
                break;
              }
            }
            
            // Fallback if ID not found, just valid so workflow doesn't crash on simple test
            if (!planRunId) {
               console.log('Warning: Could not find original plan run ID. Proceeding with generic context.');
            }
            
            originalPrompt = 'Work on Jira ticket';
            core.setOutput('original_prompt', originalPrompt);
            core.setOutput('plan_run_id', planRunId);

      - name: Prepare Agent Prompt
        id: prep_agent
        env:
          IS_REVISION: ${{ steps.context.outputs.IS_REVISION }}
          ORIGINAL_PROMPT: ${{ steps.revision_context.outputs.original_prompt }}
          REVISION_FEEDBACK: ${{ steps.context.outputs.REVISION_FEEDBACK }}
          PROMPT: ${{ steps.context.outputs.PROMPT }}
          ROLE: ${{ steps.context.outputs.ROLE }}
        run: |
          if [ "$IS_REVISION" = "true" ]; then
            BASE_PROMPT="$ORIGINAL_PROMPT"
            TASK_INSTRUCTION="$BASE_PROMPT"$'\n\n'"REVISION REQUEST: The previous plan needs to be revised based on: $REVISION_FEEDBACK"
          else
            TASK_INSTRUCTION="$PROMPT"
          fi
          
          CONTRACT_FILE="agent-contracts/${ROLE}.md"
          
          FULL_PROMPT="You are the Oris Backend Engineer AI.
          
          ### CRITICAL RESOURCES:
          Your mandatory behavior contract and architecture rules are located in: '${CONTRACT_FILE}'.
          
          ### RULES:
          1. **READ THE CONTRACT**: Use your file system tools to read '${CONTRACT_FILE}' immediately.
          2. **MCP TOOLS**: 
             - Use Notion MCP to search for 'Domain Definition' and the Jira ticket key.
             - Summarize findings in 'Notion References'.
          
          ### TASK:
          $TASK_INSTRUCTION
          
          IMPORTANT: Stop after 'Proposed Plan'. Do not implement yet."
          
          echo "ENHANCED_PROMPT<<EOF" >> $GITHUB_OUTPUT
          echo "$FULL_PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run AI Agent (Unified Script)
        id: agent_plan_run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          RUNTIME: ${{ steps.context.outputs.RUNTIME }}
          ROLE: ${{ steps.context.outputs.ROLE }}
          ENHANCED_PROMPT: ${{ steps.prep_agent.outputs.ENHANCED_PROMPT }}
        run: |
          set +e
          OUTPUT_FILE=$(mktemp)
          ERROR_FILE=$(mktemp)
          
          echo "Running agent with Runtime: $RUNTIME"
          
          ./scripts/agent.sh \
            --runtime "$RUNTIME" \
            --role "$ROLE" \
            "$ENHANCED_PROMPT" \
            > "$OUTPUT_FILE" 2> "$ERROR_FILE"
          
          EXIT_CODE=$?
          
          echo "PLAN_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat "$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "PLAN_ERROR<<EOF" >> $GITHUB_OUTPUT
          cat "$ERROR_FILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          mkdir -p plan-output-temp
          cp "$OUTPUT_FILE" plan-output-temp/output.txt
          cp "$ERROR_FILE" plan-output-temp/error.txt
          echo "$EXIT_CODE" > plan-output-temp/exit_code.txt

      - name: Display plan output
        if: steps.agent_plan_run.outputs.PLAN_OUTPUT != ''
        run: |
          echo "## ðŸ¤– AI Agent Plan Output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat plan-output-temp/output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: agent-plan
          path: plan-output-temp/
          retention-days: 7

      - name: Save Context Artifacts
        run: |
          mkdir -p plan-context
          echo "${{ steps.prep_agent.outputs.ENHANCED_PROMPT }}" > plan-context/prompt.txt
          echo "${{ steps.context.outputs.ROLE }}" > plan-context/role.txt
          echo "${{ steps.context.outputs.RUNTIME }}" > plan-context/runtime.txt
          echo "${{ steps.context.outputs.JIRA_KEY }}" > plan-context/jira_ticket.txt

      - name: Upload Context
        uses: actions/upload-artifact@v4
        with:
          name: agent-context
          path: plan-context/

      - name: Post plan comment
        if: steps.context.outputs.ISSUE_NUMBER != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ steps.context.outputs.ISSUE_NUMBER }}';
            const planOutput = `${{ steps.agent_plan_run.outputs.PLAN_OUTPUT }}`;
            const isRevision = '${{ steps.context.outputs.IS_REVISION }}' === 'true';
            
            const header = isRevision ? '## ðŸ”„ AI Agent Plan (Revised)' : '## ðŸ¤– AI Agent Plan';
            
            const body = `${header}\n\n${planOutput}\n\n---\n**Run ID:** ${process.env.GITHUB_RUN_ID}\nTo proceed, comment: \`/proceed\``;
            
            github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # NOTE: This implementation job will run immediately after plan
  # UNLESS you have "Required Reviewers" set up on the 'agent-implementation' environment in GitHub Settings.
  implement:
    needs: plan
    runs-on: ubuntu-latest
    environment:
      name: agent-implementation
    permissions:
      contents: write
      issues: write
      pull-requests: write
      checks: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: agent-context
          path: plan-context/

      - name: Read context
        id: plan_context
        run: |
          PROMPT=$(cat plan-context/prompt.txt)
          ROLE=$(cat plan-context/role.txt)
          RUNTIME=$(cat plan-context/runtime.txt)
          
          JIRA_KEY=""
          if [ -f plan-context/jira_ticket.txt ]; then
             JIRA_KEY=$(cat plan-context/jira_ticket.txt)
          fi
          
          {
            echo "PROMPT<<EOF"
            echo "$PROMPT"
            echo "EOF"
            echo "ROLE=$ROLE"
            echo "RUNTIME=$RUNTIME"
            echo "JIRA_KEY=$JIRA_KEY"
          } >> $GITHUB_OUTPUT

      - name: Setup Branch
        id: setup_branch
        env:
          JIRA_KEY: ${{ steps.plan_context.outputs.JIRA_KEY }}
        run: |
          if [ -n "$JIRA_KEY" ]; then
             KEY_LOWER=$(echo "$JIRA_KEY" | tr '[:upper:]' '[:lower:]')
             BRANCH_NAME="feature/$KEY_LOWER"
          
             echo "Target Branch: $BRANCH_NAME"
             echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
             git config --global user.name "github-actions[bot]"
             git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
             git fetch origin
             if git rev-parse --verify "origin/$BRANCH_NAME" >/dev/null 2>&1; then
                git checkout -B "$BRANCH_NAME" "origin/$BRANCH_NAME"
             else
                git checkout -b "$BRANCH_NAME"
             fi
          else
             echo "No Jira ticket found. Staying on current branch."
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache npm packages
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install AI CLI Tools
        run: npm install -g @google/gemini-cli

      - name: Configure MCP
        run: |
          mkdir -p ~/.gemini
          node << 'EOF'
          const fs = require('fs');
          const mcpServers = {};
          if (process.env.NOTION_API_KEY) {
            mcpServers.notion = {
              command: "npx",
              args: ["-y", "@modelcontextprotocol/server-notion"],
              env: { NOTION_API_KEY: process.env.NOTION_API_KEY }
            };
          }
          fs.writeFileSync(process.env.HOME + '/.gemini/settings.json', JSON.stringify({mcpServers}, null, 2));
          EOF
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}

      - name: Setup environment
        run: |
          chmod +x scripts/agent.sh
          chmod +x scripts/runtimes/*.sh

      - name: Prepare Implementation Prompt
        id: prep_impl
        env:
          BASE_PROMPT: ${{ steps.plan_context.outputs.PROMPT }}
          ROLE: ${{ steps.plan_context.outputs.ROLE }}
        run: |
          CONTRACT_FILE="agent-contracts/${ROLE}.md"
          
          IMPL_PROMPT="You are the Oris Backend Engineer AI.
          
          ### CRITICAL:
          1. **READ THE CONTRACT**: '${CONTRACT_FILE}' (Use file system tools).
          2. Follow the approved plan exactly.
          
          ### CONTEXT:
          $BASE_PROMPT
          
          ### ACTION:
          Proceed with the implementation now."
          
          echo "IMPL_PROMPT<<EOF" >> $GITHUB_OUTPUT
          echo "$IMPL_PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Implementation (Unified Script)
        id: agent_impl_run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AGENT_PROCEED: "true"
          RUNTIME: ${{ steps.plan_context.outputs.RUNTIME }}
          ROLE: ${{ steps.plan_context.outputs.ROLE }}
          IMPL_PROMPT: ${{ steps.prep_impl.outputs.IMPL_PROMPT }}
        run: |
          set +e
          OUTPUT_FILE=$(mktemp)
          ERROR_FILE=$(mktemp)
          
          ./scripts/agent.sh \
            --runtime "$RUNTIME" \
            --role "$ROLE" \
            "$IMPL_PROMPT" \
            > "$OUTPUT_FILE" 2> "$ERROR_FILE"
          
          EXIT_CODE=$?
          
          echo "IMPL_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat "$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          mkdir -p impl-artifact
          cp "$OUTPUT_FILE" impl-artifact/output.txt
          cp "$ERROR_FILE" impl-artifact/error.txt

      - name: Commit and Push Changes
        if: steps.setup_branch.outputs.BRANCH_NAME != ''
        run: |
          BRANCH_NAME="${{ steps.setup_branch.outputs.BRANCH_NAME }}"
          git add .
          if ! git diff --cached --quiet; then
             git commit -m "feat: Implementation for ${{ steps.plan_context.outputs.JIRA_KEY }}"
             git push origin "$BRANCH_NAME"
          else
             echo "No changes to commit."
          fi

      - name: Create Summary
        if: always()
        run: |
          echo "## âœ… Implementation Result" >> $GITHUB_STEP_SUMMARY
          if [ -f impl-artifact/output.txt ]; then
             cat impl-artifact/output.txt >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f impl-artifact/error.txt ] && [ -s impl-artifact/error.txt ]; then
             echo "### Errors" >> $GITHUB_STEP_SUMMARY
             cat impl-artifact/error.txt >> $GITHUB_STEP_SUMMARY
          fi