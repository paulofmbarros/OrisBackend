name: AI Agent - Plan Phase

on:
  workflow_dispatch:
    inputs:
      jira_ticket:
        description: 'Jira ticket key (e.g., OR-25)'
        required: true
        type: string
      role:
        description: 'Agent role'
        required: false
        default: 'backend'
        type: choice
        options:
          - backend
      runtime:
        description: 'AI Runtime'
        required: false
        default: 'gemini'
        type: choice
        options:
          - gemini
          - claude
          - codex
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      checks: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract trigger context
        id: context
        run: |
          JIRA_KEY=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            JIRA_KEY="${{ github.event.inputs.jira_ticket }}"
            echo "PROMPT=Work on Jira ticket $JIRA_KEY" >> $GITHUB_OUTPUT
            echo "ROLE=${{ github.event.inputs.role }}" >> $GITHUB_OUTPUT
            echo "RUNTIME=${{ github.event.inputs.runtime }}" >> $GITHUB_OUTPUT
            echo "ISSUE_NUMBER=" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            if echo "$COMMENT_BODY" | grep -qE "^\s*/agent\s+"; then
              PROMPT=$(echo "$COMMENT_BODY" | sed -E 's|^\s*/agent\s+||')
              # Extract JIRA_KEY from prompt if present
              JIRA_KEY=$(echo "$PROMPT" | grep -oE '[A-Z]+-[0-9]+' | head -1 || echo "")
              echo "PROMPT=$PROMPT" >> $GITHUB_OUTPUT
              echo "ROLE=backend" >> $GITHUB_OUTPUT
              echo "RUNTIME=gemini" >> $GITHUB_OUTPUT
              echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
              echo "IS_REVISION=false" >> $GITHUB_OUTPUT
            elif echo "$COMMENT_BODY" | grep -qE "^\s*/revise\s+"; then
              REVISION_FEEDBACK=$(echo "$COMMENT_BODY" | sed -E 's|^\s*/revise\s+||')
              # Try to get JIRA_KEY from issue title
              ISSUE_TITLE="${{ github.event.issue.title }}"
              JIRA_KEY=$(echo "$ISSUE_TITLE" | grep -oE '[A-Z]+-[0-9]+' | head -1 || echo "")
              echo "REVISION_FEEDBACK=$REVISION_FEEDBACK" >> $GITHUB_OUTPUT
              echo "IS_REVISION=true" >> $GITHUB_OUTPUT
              echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
              echo "ROLE=backend" >> $GITHUB_OUTPUT
              echo "RUNTIME=gemini" >> $GITHUB_OUTPUT
            else
              echo "SKIP=true" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_BODY="${{ github.event.pull_request.body }}"
            JIRA_KEY=$(echo "$PR_TITLE $PR_BODY" | grep -oE '[A-Z]+-[0-9]+' | head -1)
            if [ -n "$JIRA_KEY" ]; then
              echo "PROMPT=Work on Jira ticket $JIRA_KEY" >> $GITHUB_OUTPUT
              echo "ROLE=backend" >> $GITHUB_OUTPUT
              echo "RUNTIME=gemini" >> $GITHUB_OUTPUT
              echo "ISSUE_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            else
              echo "SKIP=true" >> $GITHUB_OUTPUT
            fi
          fi
          
          echo "JIRA_KEY=$JIRA_KEY" >> $GITHUB_OUTPUT

      - name: Skip if not agent trigger
        if: steps.context.outputs.SKIP == 'true'
        run: |
          echo "Not an agent trigger, skipping..."
          exit 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache npm packages
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install AI CLI Tools
        run: | 
          npm install -g @google/gemini-cli
          # npm install -g @openai/codex # (Opcional, dependendo do que o teu codex.sh usa internamente)

      - name: Setup environment
        run: |
          chmod +x scripts/agent.sh
          chmod +x scripts/runtimes/*.sh

      - name: Handle plan revision
        if: steps.context.outputs.IS_REVISION == 'true'
        id: revision_context
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.context.outputs.ISSUE_NUMBER }}'),
            });
            
            let originalPrompt = null;
            let planRunId = null;
            for (const comment of comments.data.reverse()) {
              const runIdMatch = comment.body.match(/Agent Plan Run ID: (\d+)/);
              if (runIdMatch && comment.body.includes('ðŸ¤– AI Agent Plan')) {
                planRunId = runIdMatch[1];
                break;
              }
            }
            
            if (!planRunId) {
              core.setFailed('Could not find original plan run ID.');
              return;
            }
            
            originalPrompt = 'Work on Jira ticket';
            core.setOutput('original_prompt', originalPrompt);
            core.setOutput('plan_run_id', planRunId);

      - name: Prepare Agent Prompt
        id: prep_agent
        run: |
          if [ "${{ steps.context.outputs.IS_REVISION }}" = "true" ]; then
            BASE_PROMPT="${{ steps.revision_context.outputs.original_prompt }}"
            REVISION_FEEDBACK="${{ steps.context.outputs.REVISION_FEEDBACK }}"
            TASK_INSTRUCTION="$BASE_PROMPT"$'\n\n'"REVISION REQUEST: The previous plan needs to be revised based on: $REVISION_FEEDBACK"
          else
            TASK_INSTRUCTION="${{ steps.context.outputs.PROMPT }}"
          fi
          
          ROLE="${{ steps.context.outputs.ROLE }}"
          CONTRACT_FILE="agent-contracts/${ROLE}.md"
          
          # Prompt Otimizado
          FULL_PROMPT="You are the Oris Backend Engineer AI.
          
          ### CRITICAL RESOURCES:
          Your mandatory behavior contract and architecture rules are located in: '${CONTRACT_FILE}'.
          
          ### RULES:
          1. **READ THE CONTRACT**: Use your file system tools to read '${CONTRACT_FILE}' immediately.
          2. **MCP TOOLS**: 
             - Use Notion MCP to search for 'Domain Definition' and the Jira ticket key.
             - Summarize findings in 'Notion References'.
          
          ### TASK:
          $TASK_INSTRUCTION
          
          IMPORTANT: Stop after 'Proposed Plan'. Do not implement yet."
          
          echo "ENHANCED_PROMPT<<EOF" >> $GITHUB_OUTPUT
          echo "$FULL_PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run AI Agent (Unified Script)
        id: agent_plan_run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          set +e
          OUTPUT_FILE=$(mktemp)
          ERROR_FILE=$(mktemp)
          
          # Passamos o runtime exatamente como veio do input (codex, gemini, etc)
          RUNTIME="${{ steps.context.outputs.RUNTIME }}"
          
          echo "Running agent with Runtime: $RUNTIME"
          
          ./scripts/agent.sh \
            --runtime "$RUNTIME" \
            --role "${{ steps.context.outputs.ROLE }}" \
            "${{ steps.prep_agent.outputs.ENHANCED_PROMPT }}" \
            > "$OUTPUT_FILE" 2> "$ERROR_FILE"
          
          EXIT_CODE=$?
          
          echo "PLAN_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat "$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "PLAN_ERROR<<EOF" >> $GITHUB_OUTPUT
          cat "$ERROR_FILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          mkdir -p plan-output-temp
          cp "$OUTPUT_FILE" plan-output-temp/output.txt
          cp "$ERROR_FILE" plan-output-temp/error.txt
          echo "$EXIT_CODE" > plan-output-temp/exit_code.txt
          
          echo "$PLAN_OUTPUT" > temp_plan.txt
          PLAN_SECTION=$(awk '/### Proposed Plan/,/### Architecture Verification|### Implementation|^---$|^$/{print}' temp_plan.txt | head -n -1)
          rm temp_plan.txt
          echo "PLAN_SECTION<<EOF" >> $GITHUB_OUTPUT
          echo "$PLAN_SECTION" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Display plan output
        if: steps.agent_plan_run.outputs.PLAN_OUTPUT != ''
        run: |
          echo "## ðŸ¤– AI Agent Plan Output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat plan-output-temp/output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: agent-plan
          path: plan-output-temp/
          retention-days: 7

      - name: Save Context Artifacts
        run: |
          mkdir -p plan-context
          echo "${{ steps.prep_agent.outputs.ENHANCED_PROMPT }}" > plan-context/prompt.txt
          echo "${{ steps.context.outputs.ROLE }}" > plan-context/role.txt
          echo "${{ steps.context.outputs.RUNTIME }}" > plan-context/runtime.txt
          echo "${{ steps.context.outputs.JIRA_KEY }}" > plan-context/jira_ticket.txt
        
      - name: Upload Context
        uses: actions/upload-artifact@v4
        with:
          name: agent-context
          path: plan-context/

      - name: Post plan comment
        if: steps.context.outputs.ISSUE_NUMBER != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ steps.context.outputs.ISSUE_NUMBER }}';
            const planOutput = `${{ steps.agent_plan_run.outputs.PLAN_OUTPUT }}`;
            const isRevision = '${{ steps.context.outputs.IS_REVISION }}' === 'true';
            
            const header = isRevision ? '## ðŸ”„ AI Agent Plan (Revised)' : '## ðŸ¤– AI Agent Plan';
            
            const body = `${header}\n\n${planOutput}\n\n---\n**Run ID:** ${process.env.GITHUB_RUN_ID}\nTo proceed, comment: \`/proceed\``;
            
            github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  implement:
    needs: plan
    runs-on: ubuntu-latest
    environment:
      name: agent-implementation
    permissions:
      contents: write
      issues: write
      pull-requests: write
      checks: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: agent-context
          path: plan-context/

      - name: Read context
        id: plan_context
        run: |
          PROMPT=$(cat plan-context/prompt.txt)
          ROLE=$(cat plan-context/role.txt)
          RUNTIME=$(cat plan-context/runtime.txt)
          
          JIRA_KEY=""
          if [ -f plan-context/jira_ticket.txt ]; then
             JIRA_KEY=$(cat plan-context/jira_ticket.txt)
          fi
          
          echo "PROMPT=$PROMPT" >> $GITHUB_OUTPUT
          echo "ROLE=$ROLE" >> $GITHUB_OUTPUT
          echo "RUNTIME=$RUNTIME" >> $GITHUB_OUTPUT
          echo "JIRA_KEY=$JIRA_KEY" >> $GITHUB_OUTPUT

      - name: Setup Branch
        id: setup_branch
        run: |
          JIRA_KEY="${{ steps.plan_context.outputs.JIRA_KEY }}"
          if [ -n "$JIRA_KEY" ]; then
             # Convert to lowercase
             KEY_LOWER=$(echo "$JIRA_KEY" | tr '[:upper:]' '[:lower:]')
             BRANCH_NAME="feature/$KEY_LOWER"
             
             echo "Target Branch: $BRANCH_NAME"
             echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_OUTPUT
             
             # Configure Git
             git config --global user.name "github-actions[bot]"
             git config --global user.email "github-actions[bot]@users.noreply.github.com"
             
             # Fetch origin
             git fetch origin
             
             # Switch to branch
             if git rev-parse --verify "origin/$BRANCH_NAME" >/dev/null 2>&1; then
                echo "Branch exists remotely. Checking out..."
                git checkout -B "$BRANCH_NAME" "origin/$BRANCH_NAME"
             else
                echo "Branch does not exist. Creating new..."
                git checkout -b "$BRANCH_NAME"
             fi
          else
             echo "No Jira ticket found. Staying on current branch."
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache npm packages
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
          
      - name: Install AI CLI Tools
        run: npm install -g @google/gemini-cli

      - name: Configure MCP
        run: |
          mkdir -p ~/.gemini
          node << 'EOF'
          const fs = require('fs');
          const mcpServers = {};
          if (process.env.NOTION_API_KEY) {
            mcpServers.notion = {
              command: "npx",
              args: ["-y", "@modelcontextprotocol/server-notion"],
              env: { NOTION_API_KEY: process.env.NOTION_API_KEY }
            };
          }
          fs.writeFileSync(process.env.HOME + '/.gemini/settings.json', JSON.stringify({mcpServers}, null, 2));
          EOF
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}

      - name: Setup environment
        run: |
          chmod +x scripts/agent.sh
          chmod +x scripts/runtimes/*.sh

      - name: Prepare Implementation Prompt
        id: prep_impl
        run: |
          BASE_PROMPT="${{ steps.plan_context.outputs.PROMPT }}"
          ROLE="${{ steps.plan_context.outputs.ROLE }}"
          CONTRACT_FILE="agent-contracts/${ROLE}.md"
          
          IMPL_PROMPT="You are the Oris Backend Engineer AI.
          
          ### CRITICAL:
          1. **READ THE CONTRACT**: '${CONTRACT_FILE}' (Use file system tools).
          2. Follow the approved plan exactly.
          
          ### CONTEXT:
          $BASE_PROMPT
          
          ### ACTION:
          Proceed with the implementation now."
          
          echo "IMPL_PROMPT<<EOF" >> $GITHUB_OUTPUT
          echo "$IMPL_PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Implementation (Unified Script)
        id: agent_impl_run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AGENT_PROCEED: "true"
        run: |
          set +e
          OUTPUT_FILE=$(mktemp)
          ERROR_FILE=$(mktemp)
          
          RUNTIME="${{ steps.plan_context.outputs.RUNTIME }}"
          
          ./scripts/agent.sh \
            --runtime "$RUNTIME" \
            --role "${{ steps.plan_context.outputs.ROLE }}" \
            "${{ steps.prep_impl.outputs.IMPL_PROMPT }}" \
            > "$OUTPUT_FILE" 2> "$ERROR_FILE"
          
          EXIT_CODE=$?
          
          echo "IMPL_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat "$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          mkdir -p impl-artifact
          cp "$OUTPUT_FILE" impl-artifact/output.txt
          cp "$ERROR_FILE" impl-artifact/error.txt

      - name: Commit and Push Changes
        if: steps.setup_branch.outputs.BRANCH_NAME != ''
        run: |
           BRANCH_NAME="${{ steps.setup_branch.outputs.BRANCH_NAME }}"
           git add .
           if ! git diff --cached --quiet; then
              git commit -m "feat: Implementation for ${{ steps.plan_context.outputs.JIRA_KEY }}"
              git push origin "$BRANCH_NAME"
           else
              echo "No changes to commit."
           fi

      - name: Create Summary
        if: always()
        run: |
          echo "## âœ… Implementation Result" >> $GITHUB_STEP_SUMMARY
          if [ -f impl-artifact/output.txt ]; then
             cat impl-artifact/output.txt >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f impl-artifact/error.txt ] && [ -s impl-artifact/error.txt ]; then
             echo "### Errors" >> $GITHUB_STEP_SUMMARY
             cat impl-artifact/error.txt >> $GITHUB_STEP_SUMMARY
          fi