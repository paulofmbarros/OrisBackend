name: AI Agent - Plan Phase

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      jira_ticket:
        description: 'Jira ticket key'
        required: true
        type: string
      role:
        default: 'backend'
        type: choice
        options: [backend]
      runtime:
        default: 'gemini'
        type: choice
        options: [gemini, claude, codex]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract context
        id: context
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "PROMPT=Work on Jira ticket ${{ github.event.inputs.jira_ticket }}" >> $GITHUB_OUTPUT
            echo "ROLE=${{ github.event.inputs.role }}" >> $GITHUB_OUTPUT
            echo "RUNTIME=${{ github.event.inputs.runtime }}" >> $GITHUB_OUTPUT
          else
            # Default fallback for PRs/Comments
            echo "PROMPT=Work on Jira ticket" >> $GITHUB_OUTPUT
            echo "ROLE=backend" >> $GITHUB_OUTPUT
            echo "RUNTIME=gemini" >> $GITHUB_OUTPUT
          fi

      - name: Setup environment
        run: |
          chmod +x scripts/agent.sh
          chmod +x scripts/runtimes/*.sh
          npm install -g @google/gemini-cli

      # Initialization: This installs the 'codex' binary and sets up the toolpath.
      # We send a tiny dummy prompt just to trigger the installation/setup logic.
      - name: Initialize Codex
        if: steps.context.outputs.RUNTIME == 'codex'
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: "Verify connection" 

      - name: Run Agent
        id: agent_run
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +e
          # Run exactly like you do locally
          ./scripts/agent.sh \
            --runtime "${{ steps.context.outputs.RUNTIME }}" \
            --role "${{ steps.context.outputs.ROLE }}" \
            "${{ steps.context.outputs.PROMPT }}" > output.txt 2> error.txt
          
          EXIT_CODE=$?
          
          # If failure, print error.txt to the GitHub logs so you can see it
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Agent failed with exit code $EXIT_CODE"
            cat error.txt
          fi

          # Save for artifacts
          mkdir -p plan-artifact
          mv output.txt plan-artifact/plan-output.txt
          mv error.txt plan-artifact/plan-error.txt
          echo "$EXIT_CODE" > plan-artifact/exit_code.txt
          exit $EXIT_CODE

      - name: Upload Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-plan
          path: plan-artifact/