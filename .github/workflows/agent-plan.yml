name: AI Agent - Plan Phase

on:
  workflow_dispatch:
    inputs:
      jira_ticket:
        description: 'Jira ticket key (e.g., OR-25)'
        required: true
        type: string
      role:
        description: 'Agent role'
        required: false
        default: 'backend'
        type: choice
        options:
          - backend
      runtime:
        description: 'AI Runtime'
        required: false
        default: 'gemini'
        type: choice
        options:
          - gemini
          - claude
          - codex
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      checks: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract trigger context
        id: context
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "PROMPT=Work on Jira ticket ${{ github.event.inputs.jira_ticket }}" >> $GITHUB_OUTPUT
            echo "ROLE=${{ github.event.inputs.role }}" >> $GITHUB_OUTPUT
            echo "RUNTIME=${{ github.event.inputs.runtime }}" >> $GITHUB_OUTPUT
            echo "ISSUE_NUMBER=" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            if echo "$COMMENT_BODY" | grep -qE "^\s*/agent\s+"; then
              PROMPT=$(echo "$COMMENT_BODY" | sed -E 's|^\s*/agent\s+||')
              echo "PROMPT=$PROMPT" >> $GITHUB_OUTPUT
              echo "ROLE=backend" >> $GITHUB_OUTPUT
              echo "RUNTIME=gemini" >> $GITHUB_OUTPUT
              echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
              echo "IS_REVISION=false" >> $GITHUB_OUTPUT
            elif echo "$COMMENT_BODY" | grep -qE "^\s*/revise\s+"; then
              # Extract revision feedback
              REVISION_FEEDBACK=$(echo "$COMMENT_BODY" | sed -E 's|^\s*/revise\s+||')
              echo "REVISION_FEEDBACK=$REVISION_FEEDBACK" >> $GITHUB_OUTPUT
              echo "IS_REVISION=true" >> $GITHUB_OUTPUT
              echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
              echo "ROLE=backend" >> $GITHUB_OUTPUT
              echo "RUNTIME=gemini" >> $GITHUB_OUTPUT
            else
              echo "SKIP=true" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # Extract Jira ticket from PR title or body
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_BODY="${{ github.event.pull_request.body }}"
            JIRA_KEY=$(echo "$PR_TITLE $PR_BODY" | grep -oE '[A-Z]+-[0-9]+' | head -1)
            if [ -n "$JIRA_KEY" ]; then
              echo "PROMPT=Work on Jira ticket $JIRA_KEY" >> $GITHUB_OUTPUT
              echo "ROLE=backend" >> $GITHUB_OUTPUT
              echo "RUNTIME=gemini" >> $GITHUB_OUTPUT
              echo "ISSUE_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            else
              echo "SKIP=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Skip if not agent trigger
        if: steps.context.outputs.SKIP == 'true'
        run: |
          echo "Not an agent trigger, skipping..."
          exit 0

      - name: Setup environment
        run: |
          # Make scripts executable
          chmod +x scripts/agent.sh
          chmod +x scripts/runtimes/*.sh

      - name: Handle plan revision
        if: steps.context.outputs.IS_REVISION == 'true'
        id: revision_context
        uses: actions/github-script@v7
        with:
          script: |
            // Find the most recent plan comment to get the original prompt
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.context.outputs.ISSUE_NUMBER }}'),
            });
            
            // Look for the most recent plan comment with run ID
            let originalPrompt = null;
            let planRunId = null;
            for (const comment of comments.data.reverse()) {
              const runIdMatch = comment.body.match(/Agent Plan Run ID: (\d+)/);
              if (runIdMatch && comment.body.includes('ü§ñ AI Agent Plan')) {
                planRunId = runIdMatch[1];
                // Try to extract original prompt from comment or find it in artifacts
                break;
              }
            }
            
            if (!planRunId) {
              core.setFailed('Could not find original plan. Please ensure a plan was generated first.');
              return;
            }
            
            // Download the original plan artifact to get the prompt
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            try {
              // Use the artifact download action's approach
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: parseInt(planRunId),
              });
            
              const planArtifact = artifacts.data.artifacts.find(a => a.name === 'agent-plan');
              if (planArtifact) {
                const download = await github.rest.actions.downloadArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: planArtifact.id,
                  archive_format: 'zip',
                });
            
                fs.mkdirSync('original-plan', { recursive: true });
                fs.writeFileSync('original-plan.zip', Buffer.from(download.data));
                execSync('unzip -q original-plan.zip -d original-plan/');
            
                if (fs.existsSync('original-plan/prompt.txt')) {
                  originalPrompt = fs.readFileSync('original-plan/prompt.txt', 'utf8').trim();
                }
            
                execSync('rm -rf original-plan original-plan.zip');
              }
            } catch (error) {
              core.warning(`Could not download original plan artifact: ${error.message}`);
            }
            
            // Fallback: try to extract from comment or use a default
            if (!originalPrompt) {
              // We'll construct it from the revision feedback
              originalPrompt = 'Work on Jira ticket'; // Will be enhanced with revision feedback
            }
            
            core.setOutput('original_prompt', originalPrompt || '');
            core.setOutput('plan_run_id', planRunId);

      - name: Run agent planning phase
        id: agent_plan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +e  # Don't fail on non-zero exit, we want to capture output
          
          OUTPUT_FILE=$(mktemp)
          ERROR_FILE=$(mktemp)
          
          # Build the prompt - either original or with revision feedback
          if [ "${{ steps.context.outputs.IS_REVISION }}" = "true" ]; then
            ORIGINAL_PROMPT="${{ steps.revision_context.outputs.original_prompt }}"
            REVISION_FEEDBACK="${{ steps.context.outputs.REVISION_FEEDBACK }}"
          
            # If we couldn't get the original prompt, try to infer it
            if [ -z "$ORIGINAL_PROMPT" ] || [ "$ORIGINAL_PROMPT" = "Work on Jira ticket" ]; then
              # Try to extract Jira ticket from issue/PR
              ORIGINAL_PROMPT="Work on Jira ticket"
            fi
          
            # Create enhanced prompt with revision feedback
            ENHANCED_PROMPT="$ORIGINAL_PROMPT

REVISION REQUEST:
The previous plan needs to be revised based on the following feedback:
  $REVISION_FEEDBACK
  
  Please generate a revised plan that addresses this feedback while maintaining alignment with the original requirements."
  else
  ENHANCED_PROMPT="${{ steps.context.outputs.PROMPT }}"
  fi
  
  # Run agent and capture output
  ./scripts/agent.sh \
  --runtime "${{ steps.context.outputs.RUNTIME }}" \
  --role "${{ steps.context.outputs.ROLE }}" \
  "$ENHANCED_PROMPT" \
  > "$OUTPUT_FILE" 2> "$ERROR_FILE"
  
  EXIT_CODE=$?
  
  # Save outputs
  echo "PLAN_OUTPUT<<EOF" >> $GITHUB_OUTPUT
  cat "$OUTPUT_FILE" >> $GITHUB_OUTPUT
  echo "EOF" >> $GITHUB_OUTPUT
  
  echo "PLAN_ERROR<<EOF" >> $GITHUB_OUTPUT
  cat "$ERROR_FILE" >> $GITHUB_OUTPUT
  echo "EOF" >> $GITHUB_OUTPUT
  
  echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_OUTPUT
  
  # Extract plan section (everything after "### Proposed Plan")
  PLAN_SECTION=$(awk '/### Proposed Plan/,/### Architecture Verification|### Implementation|^---$|^$/{print}' "$OUTPUT_FILE" | head -n -1)
  echo "PLAN_SECTION<<EOF" >> $GITHUB_OUTPUT
  echo "$PLAN_SECTION" >> $GITHUB_OUTPUT
  echo "EOF" >> $GITHUB_OUTPUT
  
  # Save to artifact for next job
  mkdir -p plan-artifact
  cp "$OUTPUT_FILE" plan-artifact/plan-output.txt
  cp "$ERROR_FILE" plan-artifact/plan-error.txt
  
  # Save the enhanced prompt (original or with revision)
  if [ "${{ steps.context.outputs.IS_REVISION }}" = "true" ]; then
  echo "$ENHANCED_PROMPT" > plan-artifact/prompt.txt
  else
  echo "${{ steps.context.outputs.PROMPT }}" > plan-artifact/prompt.txt
  fi
  
  echo "${{ steps.context.outputs.ROLE }}" > plan-artifact/role.txt
  echo "${{ steps.context.outputs.RUNTIME }}" > plan-artifact/runtime.txt
  
  # Mark if this is a revision
  echo "${{ steps.context.outputs.IS_REVISION }}" > plan-artifact/is-revision.txt
  if [ "${{ steps.context.outputs.IS_REVISION }}" = "true" ]; then
  echo "${{ steps.context.outputs.REVISION_FEEDBACK }}" > plan-artifact/revision-feedback.txt
  fi
  
  rm -f "$OUTPUT_FILE" "$ERROR_FILE"

- name: Upload plan artifact
  uses: actions/upload-artifact@v4
  with:
    name: agent-plan
    path: plan-artifact/
    retention-days: 7

- name: Post plan as comment
  if: steps.context.outputs.ISSUE_NUMBER != ''
  uses: actions/github-script@v7
  with:
    script: |
      const issueNumber = '${{ steps.context.outputs.ISSUE_NUMBER }}';
      const planOutput = `${{ steps.agent_plan.outputs.PLAN_OUTPUT }}`;
      const planSection = `${{ steps.agent_plan.outputs.PLAN_SECTION }}`;
      
      const isRevision = '${{ steps.context.outputs.IS_REVISION }}' === 'true';
      const revisionHeader = isRevision ? '## üîÑ AI Agent Plan (Revised)\n\n' : '## ü§ñ AI Agent Plan\n\n';
      const revisionNote = isRevision 
        ? '> **Note:** This is a revised plan based on your feedback.\n\n' 
        : '';
      
      const body = `${revisionHeader}${revisionNote}${planOutput}
      
      ---
      
      ### ‚ö†Ô∏è Review Required
      
      **Options:**
      1. ‚úÖ **Approve and proceed**: Click the "Review deployments" button below and approve, or comment: \`/proceed\`
      2. üîÑ **Request changes**: Comment: \`/revise <your feedback here>\` to modify the plan
      3. ‚ùå **Cancel**: Close this issue/PR
      
      **Example revision:**
      \`/revise Please use a different approach for authentication. Consider using JWT tokens instead.\`
      
      <!-- Agent Plan Run ID: ${process.env.GITHUB_RUN_ID} -->`;
      
      github.rest.issues.createComment({
        issue_number: issueNumber,
        owner: context.repo.owner,
        repo: context.repo.repo,
        body: body
      });

- name: Create check run with plan
  uses: actions/github-script@v7
  with:
    script: |
      const planOutput = `${{ steps.agent_plan.outputs.PLAN_OUTPUT }}`;
      const planError = `${{ steps.agent_plan.outputs.PLAN_ERROR }}`;
      const exitCode = parseInt('${{ steps.agent_plan.outputs.EXIT_CODE }}');
      
      const conclusion = exitCode === 0 ? 'success' : 'failure';
      const title = exitCode === 0 ? '‚úÖ Plan Generated' : '‚ùå Plan Generation Failed';
      
      const output = {
        title: title,
        summary: exitCode === 0 
          ? 'AI Agent has generated a plan. Review and approve to proceed with implementation.'
          : 'AI Agent failed to generate a plan. Check the output for errors.',
        text: planOutput + (planError ? '\n\n---\n\n**Errors:**\n' + planError : '')
      };
      
      await github.rest.checks.create({
        owner: context.repo.owner,
        repo: context.repo.repo,
        name: 'AI Agent Plan',
        head_sha: context.sha,
        status: 'completed',
        conclusion: conclusion,
        output: output
      });

implement:
  needs: plan
  runs-on: ubuntu-latest
  environment:
    name: agent-implementation
    # This creates the approval gate - configure required reviewers in GitHub Settings
  permissions:
    contents: write
    issues: write
    pull-requests: write
    checks: write

  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Download plan artifact
      uses: actions/download-artifact@v4
      with:
        name: agent-plan
        path: plan-artifact/

    - name: Read plan context
      id: plan_context
      run: |
        PROMPT=$(cat plan-artifact/prompt.txt)
        ROLE=$(cat plan-artifact/role.txt)
        RUNTIME=$(cat plan-artifact/runtime.txt)
        
        echo "PROMPT=$PROMPT" >> $GITHUB_OUTPUT
        echo "ROLE=$ROLE" >> $GITHUB_OUTPUT
        echo "RUNTIME=$RUNTIME" >> $GITHUB_OUTPUT

    - name: Setup environment
      run: |
        chmod +x scripts/agent.sh
        chmod +x scripts/runtimes/*.sh

    - name: Run agent implementation phase
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        AGENT_PROCEED: "true"
      run: |
        # Modify the prompt to include proceed instruction
        PROCEED_PROMPT="${{ steps.plan_context.outputs.PROMPT }}
        
        Proceed with the implementation."
        
        ./scripts/agent.sh \
          --runtime "${{ steps.plan_context.outputs.RUNTIME }}" \
          --role "${{ steps.plan_context.outputs.ROLE }}" \
          "$PROCEED_PROMPT"

    - name: Create implementation summary
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          const body = `## ‚úÖ Implementation Complete
          
          The AI Agent has completed the implementation based on the approved plan.
          
          **Next steps:**
          - Review the changes in this PR
          - Run tests locally if needed
          - Merge when ready
          
          <!-- Implementation for Plan ID: ${process.env.GITHUB_RUN_ID} -->`;
          
          // Try to find the issue/PR number from context
          if (context.payload.issue) {
            github.rest.issues.createComment({
              issue_number: context.payload.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          } else if (context.payload.pull_request) {
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          }