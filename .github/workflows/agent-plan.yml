name: AI Agent - Plan Phase

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      jira_ticket:
        description: 'Jira ticket key (e.g., OR-25)'
        required: true
        type: string
      role:
        description: 'Agent role'
        required: false
        default: 'backend'
        type: choice
        options:
          - backend
      runtime:
        description: 'AI Runtime'
        required: false
        default: 'gemini'
        type: choice
        options:
          - gemini
          - claude
          - codex
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      checks: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract trigger context
        id: context
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "PROMPT=Work on Jira ticket ${{ github.event.inputs.jira_ticket }}" >> $GITHUB_OUTPUT
            echo "ROLE=${{ github.event.inputs.role }}" >> $GITHUB_OUTPUT
            echo "RUNTIME=${{ github.event.inputs.runtime }}" >> $GITHUB_OUTPUT
            echo "ISSUE_NUMBER=" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            if echo "$COMMENT_BODY" | grep -qE "^\s*/agent\s+"; then
              PROMPT=$(echo "$COMMENT_BODY" | sed -E 's|^\s*/agent\s+||')
              echo "PROMPT=$PROMPT" >> $GITHUB_OUTPUT
              echo "ROLE=backend" >> $GITHUB_OUTPUT
              echo "RUNTIME=gemini" >> $GITHUB_OUTPUT
              echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            elif echo "$COMMENT_BODY" | grep -qE "^\s*/revise\s+"; then
              REVISION_FEEDBACK=$(echo "$COMMENT_BODY" | sed -E 's|^\s*/revise\s+||')
              echo "REVISION_FEEDBACK=$REVISION_FEEDBACK" >> $GITHUB_OUTPUT
              echo "IS_REVISION=true" >> $GITHUB_OUTPUT
              echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
              echo "ROLE=backend" >> $GITHUB_OUTPUT
              echo "RUNTIME=gemini" >> $GITHUB_OUTPUT
            else
              echo "SKIP=true" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_BODY="${{ github.event.pull_request.body }}"
            JIRA_KEY=$(echo "$PR_TITLE $PR_BODY" | grep -oE '[A-Z]+-[0-9]+' | head -1)
            if [ -n "$JIRA_KEY" ]; then
              echo "PROMPT=Work on Jira ticket $JIRA_KEY" >> $GITHUB_OUTPUT
              echo "ROLE=backend" >> $GITHUB_OUTPUT
              echo "RUNTIME=gemini" >> $GITHUB_OUTPUT
              echo "ISSUE_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            else
              echo "SKIP=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Skip if not agent trigger
        if: steps.context.outputs.SKIP == 'true'
        run: exit 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      - name: Setup environment
        run: |
          chmod +x scripts/agent.sh
          chmod +x scripts/runtimes/*.sh

      # Initialize Codex Binary (Unlocks 'codex' command for the shell)
      - name: Initialize Codex Runtime
        if: steps.context.outputs.RUNTIME == 'codex'
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}

      - name: Handle plan revision
        if: steps.context.outputs.IS_REVISION == 'true'
        id: revision_context
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.context.outputs.ISSUE_NUMBER }}'),
            });
            let originalPrompt = "Work on Jira ticket";
            for (const comment of comments.data.reverse()) {
              if (comment.body.includes('ðŸ¤– AI Agent Plan')) { break; }
            }
            core.setOutput('original_prompt', originalPrompt);

      - name: Prepare Agent Prompt
        id: prep_agent
        run: |
          if [ "${{ steps.context.outputs.IS_REVISION }}" = "true" ]; then
            ENHANCED_PROMPT="${{ steps.revision_context.outputs.original_prompt }}"$'\n\n'"REVISION REQUEST: ${{ steps.context.outputs.REVISION_FEEDBACK }}"
          else
            ENHANCED_PROMPT="${{ steps.context.outputs.PROMPT }}"
          fi
          echo "ENHANCED_PROMPT<<EOF" >> $GITHUB_OUTPUT
          echo "$ENHANCED_PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run agent planning phase
        id: agent_plan_run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set +e
          OUTPUT_FILE="output.txt"
          ERROR_FILE="error.txt"
          
          # We use the same entry point script for ALL runtimes now.
          # The script will call scripts/runtimes/codex.sh internally if runtime=codex.
          ./scripts/agent.sh \
            --runtime "${{ steps.context.outputs.RUNTIME }}" \
            --role "${{ steps.context.outputs.ROLE }}" \
            "${{ steps.prep_agent.outputs.ENHANCED_PROMPT }}" \
            > "$OUTPUT_FILE" 2> "$ERROR_FILE"
            
          EXIT_CODE=$?
          echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          mkdir -p plan-artifact
          cp "$OUTPUT_FILE" plan-artifact/plan-output.txt
          cp "$ERROR_FILE" plan-artifact/plan-error.txt
          echo "$EXIT_CODE" > plan-artifact/exit_code.txt
          echo "${{ steps.prep_agent.outputs.ENHANCED_PROMPT }}" > plan-artifact/prompt.txt
          echo "${{ steps.context.outputs.ROLE }}" > plan-artifact/role.txt
          echo "${{ steps.context.outputs.RUNTIME }}" > plan-artifact/runtime.txt
          exit $EXIT_CODE

      - name: Upload plan artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-plan
          path: plan-artifact/

      - name: Post plan as comment
        if: always() && steps.context.outputs.ISSUE_NUMBER != '' && steps.agent_plan_run.outputs.EXIT_CODE == '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('plan-artifact/plan-output.txt', 'utf8');
            const body = `## ðŸ¤– AI Agent Plan\n\n${planOutput}\n\n`;
            github.rest.issues.createComment({
              issue_number: ${{ steps.context.outputs.ISSUE_NUMBER }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });