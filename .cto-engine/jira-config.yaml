# Jira Configuration
# Defines how the CTO Engine connects to and interacts with Jira

version: "1.0"

# Jira instance details
jira:
  url: "https://orishealth.atlassian.net/"

  # Authentication (use environment variables for security)
  # Set JIRA_EMAIL and JIRA_API_TOKEN in your environment
  auth:
    email_env_var: "JIRA_EMAIL"
    api_token_env_var: "JIRA_API_TOKEN"

# Project configuration
project:
  key: "OR"
  name: "OrisBackend"
  mode: "team_managed"  # Options: company_managed, team_managed

  # Issue type IDs (resolved from Jira project metadata)
  issue_types:
    epic: "10011"
    story: "10013"
    task: "10010"
    bug: ""

  # Custom field mappings
  custom_fields:
    story_points: "customfield_10036"
    epic_link: "parent"          # team-managed projects link stories via parent
    epic_name: ""                # not required for team-managed
    acceptance_criteria: ""

  # Default values for new issues
  defaults:
    assignee: "unassigned"
    reporter: "auto"
    priority: "Medium"
    labels:
      - "cto-engine"

# JQL queries for snapshot generation
queries:
  # All active work (for snapshot)
  active_work: >
    project = {project_key}
    AND statusCategory IN ("To Do", "In Progress")
    ORDER BY updated DESC

  # Recently completed (last 7 days)
  recently_completed: >
    project = {project_key}
    AND statusCategory = Done
    AND resolved >= -7d
    ORDER BY resolved DESC

  # Blocked items (label-based to avoid status name coupling)
  blocked: >
    project = {project_key}
    AND labels = blocked
    ORDER BY updated DESC

  # Current sprint/week fallback view
  current_sprint: >
    project = {project_key}
    AND statusCategory IN ("To Do", "In Progress")
    ORDER BY updated DESC

  # Overdue items
  overdue: >
    project = {project_key}
    AND statusCategory != Done
    AND duedate < now()
    ORDER BY duedate ASC

# Snapshot configuration
snapshot:
  lookback_days: 7
  max_results: 100
  fields:
    - "summary"
    - "status"
    - "assignee"
    - "priority"
    - "created"
    - "updated"
    - "resolutiondate"
    - "description"
    - "labels"
    - "issuelinks"
    - "customfield_10036"

# Ticket creation rules
creation:
  epics:
    name_format: "{summary}"
    description_template: |
      **Goal:** {goal}

      **Success Criteria:**
      {success_criteria}

      **Risks:**
      {risks}

      ---
      _Auto-generated by CTO Engine_
      _Plan commit: {commit_sha}_
      _Created: {created_at}_

  stories:
    title_format: "{summary}"
    description_template: |
      h2. Objective
      {objective}

      h2. Scope
      h3. In scope
      {in_scope_bullets}

      h3. Out of scope
      {out_of_scope_bullets}

      h2. Acceptance Criteria
      {acceptance_criteria_numbered}

      {references_section}

      {constraints_section}

      h2. Definition of Done
      {definition_of_done_bullets}

      ---
      _Epic: {epic_key}_
      _Estimate: {estimate} points_
      _Auto-generated by CTO Engine_
      _Plan commit: {commit_sha}_

    auto_link_to_epic: true
    add_commit_label: true

  # Idempotency: prevent duplicate ticket creation
  idempotency:
    issue_property_key: "cto_engine.plan_commit_sha"
    check_issue_property: true
    check_commit_sha_label: true
    update_existing: true
    update_fields:
      - "description"
      - "labels"
      - "priority"
    preserve_fields:
      - "status"
      - "assignee"
      - "story_points"

# Rate limiting (be nice to Jira API)
rate_limiting:
  max_requests_per_minute: 60
  max_retries: 3
  retry_delay_seconds: 2
  exponential_backoff: true

# Validation rules
validation:
  require_estimates: true
  valid_estimates: [1, 2, 3, 5, 8, 13]
  max_story_points: 13
  max_stories_per_epic: 8
  require_acceptance_criteria: true
  min_acceptance_criteria: 1

# Error handling
error_handling:
  log_failures: true
  log_path: ".cto-engine/logs/jira-errors.log"
  fail_fast: false
  notify_on_critical: true

# Feature flags
features:
  enable_snapshot: true
  enable_ticket_creation: true
  enable_ticket_updates: true
  enable_comments: false
  enable_transitions: false

# Metadata
metadata:
  config_version: "1.0"
  last_updated: "2026-02-08"
  cto_engine_version: "0.1.0"
